name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Create nopCommerce Database
      run: |
        echo "Waiting for SQL Server to be ready..."
        sleep 20
        
        echo "Creating database..."
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") \
          /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P "Can@922946" \
          -Q "CREATE DATABASE [nopCommerce];" \
          -C

    - name: Start nopCommerce Container
      run: |
        sleep 20
        
        docker run -d \
          --name nop_app \
          --network host \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for nopCommerce to start..."
        sleep 30

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Automate Installation with Playwright
      run: |
        cat > install.mjs << 'EOF'
        import { chromium } from '@playwright/test';

        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          try {
            console.log('Opening installation page...');
            await page.goto('http://localhost:80/install', { waitUntil: 'domcontentloaded', timeout: 60000 });
            
            // Wait for form to be ready
            await page.waitForSelector('select#DataProvider', { state: 'visible', timeout: 10000 });
            
            console.log('Filling database information...');
            
            // Select SQL Server (value = "1")
            await page.selectOption('select#DataProvider', '1');
            
            // Wait for connection string fields to appear
            await page.waitForTimeout(2000);
            
            console.log('Filling connection details...');
            await page.fill('input#ServerName', 'localhost');
            await page.fill('input#DatabaseName', 'nopCommerce');
            
            // Uncheck Windows Authentication
            const integratedAuth = page.locator('input#IntegratedSecurity');
            if (await integratedAuth.isChecked()) {
              await integratedAuth.uncheck();
              await page.waitForTimeout(500);
            }
            
            await page.fill('input#Username', 'sa');
            await page.fill('input#Password', 'Can@922946');
            
            // Check Trust Server Certificate if it exists
            const trustCert = page.locator('input#TrustServerCertificate');
            if (await trustCert.count() > 0) {
              await trustCert.check();
            }
            
            console.log('Filling admin information...');
            await page.fill('input#AdminEmail', 'admin@yourstore.com');
            await page.fill('input#AdminPassword', 'admin123');
            await page.fill('input#ConfirmPassword', 'admin123');
            
            console.log('Enabling sample data...');
            const sampleDataCheckbox = page.locator('input#InstallSampleData');
            if (await sampleDataCheckbox.count() > 0) {
              await sampleDataCheckbox.check();
            }
            
            console.log('Submitting installation form...');
            const submitButton = page.locator('button[type="submit"].btn-install');
            await submitButton.click();
            
            // Wait a bit for any validation errors
            await page.waitForTimeout(3000);
            
            // Check if still on install page (validation error)
            if (page.url().includes('/install')) {
              console.log('Still on install page, checking for errors...');
              const errorMessages = await page.$$eval('.field-validation-error, .validation-summary-errors li', 
                errors => errors.map(e => e.textContent.trim())
              );
              if (errorMessages.length > 0) {
                console.error('Validation errors:', errorMessages);
              }
              
              // Try to see if install is processing
              const progressIndicator = page.locator('#installation-progress, .installation-progress, [class*="progress"]');
              if (await progressIndicator.count() > 0) {
                console.log('Installation in progress, waiting...');
              }
            }
            
            console.log('Waiting for installation to complete (this may take 3-5 minutes)...');
            
            // Try different wait strategies
            try {
              // Wait for navigation away from /install
              await page.waitForURL(url => !url.includes('/install'), { timeout: 360000 });
              console.log('✅ Redirected away from install page!');
            } catch (e) {
              console.log('No redirect detected, checking page content...');
              // Maybe installation completed but no redirect - check for home page elements
              const registerLink = page.locator('a.ico-register');
              if (await registerLink.count() > 0) {
                console.log('✅ Found register link - installation likely complete');
              } else {
                throw new Error('Installation did not complete - still on install page');
              }
            }
            
            console.log('Final URL:', page.url());
            await browser.close();
            process.exit(0);
          } catch (error) {
            console.error('❌ Installation failed:', error.message);
            await page.screenshot({ path: 'installation-error.png', fullPage: true });
            const pageContent = await page.content();
            console.log('Page HTML length:', pageContent.length);
            console.log('Page URL:', page.url());
            await browser.close();
            process.exit(1);
          }
        })();
        EOF
        
        node install.mjs

    - name: Verify Installation Success
      run: |
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)
        if [ "$STATUS" == "200" ]; then
          echo "✅ nopCommerce is ready for testing!"
        else
          echo "❌ Unexpected status: $STATUS"
          docker logs nop_app --tail 30
          exit 1
        fi

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7