name: Playwright Tests
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Create nopCommerce Database
      run: |
        echo "Waiting for SQL Server to be ready..."
        sleep 20
        
        echo "Creating database..."
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") \
          /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P "Can@922946" \
          -Q "CREATE DATABASE [nopCommerce];" \
          -C

    - name: Start nopCommerce Container
      run: |
        echo "Getting SQL Server container info..."
        SQL_CONTAINER=$(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest")
        SQL_NETWORK=$(docker inspect $SQL_CONTAINER -f '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}')
        SQL_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $SQL_CONTAINER)
        
        echo "SQL Server Network: $SQL_NETWORK"
        echo "SQL Server IP: $SQL_IP"
        echo "SQL_SERVER_IP=$SQL_IP" >> $GITHUB_ENV

        echo "Waiting for SQL Server to be fully ready..."
        sleep 30
        
        docker run -d \
          --name nop_app \
          --network $SQL_NETWORK \
          -p 5000:80 \
          --restart unless-stopped \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for nopCommerce to start..."
        sleep 30

        echo "Checking container status..."
        docker ps -a
        docker logs nop_app

    - name: Wait for nopCommerce to be Ready
      run: |
        echo "Waiting for nopCommerce to be accessible..."
        for i in {1..30}; do
          if curl -f http://localhost:5000 2>/dev/null; then
            echo "‚úÖ nopCommerce is ready!"
            exit 0
          fi
          echo "[$i/30] Waiting for nopCommerce to start..."
          sleep 5
        done
        
        echo "‚ùå nopCommerce failed to start"
        docker logs nop_app
        exit 1

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Automate Installation with Playwright
      run: |

        # L·∫•y SQL Server IP
        SQL_CONTAINER=$(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest")
        SQL_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $SQL_CONTAINER)
        
        echo "Using SQL Server IP: $SQL_IP"

        cat > install.mjs << 'EOF'
        import { chromium } from '@playwright/test';

        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          try {
            console.log('Opening installation page...');
            await page.goto('http://localhost:5000/install', { waitUntil: 'domcontentloaded', timeout: 90000 });
            
            await page.waitForSelector('select#DataProvider', { state: 'visible', timeout: 10000 });
            
            console.log('Filling database information...');
            await page.selectOption('select#DataProvider', '1');
            await page.waitForTimeout(2000);
            
            console.log('Filling connection details...');
            await page.fill('input#ServerName', process.env.SQL_IP);
            await page.fill('input#DatabaseName', 'nopCommerce');
            
            const integratedAuth = page.locator('input#IntegratedSecurity');
            if (await integratedAuth.isChecked()) {
              await integratedAuth.uncheck();
              await page.waitForTimeout(500);
            }
            
            await page.fill('input#Username', 'sa');
            await page.fill('input#Password', 'Can@922946');
            
            const trustCert = page.locator('input#TrustServerCertificate');
            if (await trustCert.count() > 0) {
              await trustCert.check();
            }
            
            console.log('Filling admin information...');
            await page.fill('input#AdminEmail', 'admin@yourstore.com');
            await page.fill('input#AdminPassword', 'admin123');
            await page.fill('input#ConfirmPassword', 'admin123');
            
            console.log('Enabling sample data...');
            const sampleDataCheckbox = page.locator('input#InstallSampleData');
            if (await sampleDataCheckbox.count() > 0) {
              await sampleDataCheckbox.check();
            }
            
            console.log('Submitting installation form...');
            const submitButton = page.locator('button[type="submit"].btn-install');
            await submitButton.click();
            
            // Wait a moment to ensure form submission started
            await page.waitForTimeout(5000);
            
            // Check for immediate validation errors
            if (page.url().includes('/install')) {
              const errorMessages = await page.$$eval('.field-validation-error, .validation-summary-errors li', 
                errors => errors.map(e => e.textContent.trim()).filter(t => t.length > 0)
              );
              if (errorMessages.length > 0) {
                console.error('‚ùå Validation errors found:', errorMessages);
                await browser.close();
                process.exit(1);
              }
            }
            
            console.log('‚úÖ Form submitted successfully! Installation is processing...');
            await browser.close();
            process.exit(0);
          } catch (error) {
            console.error('‚ùå Form submission failed:', error.message);
            await page.screenshot({ path: 'installation-error.png', fullPage: true });
            await browser.close();
            process.exit(1);
          }
        })();
        EOF
        
        SQL_IP=$SQL_IP node install.mjs

    - name: Wait for Installation to Complete
      run: |
        echo "‚è≥ Waiting for nopCommerce installation (can take 3-5 minutes for schema + sample data)..."
        echo "The app will restart automatically after installation completes."
        
        # Give it time to start the heavy database work
        sleep 30
        
        RESTART_DETECTED=false
        
        for i in {1..60}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:5000 2>/dev/null || echo "000")
          
          # Status 200 with home page = SUCCESS
          if [ "$STATUS" == "200" ]; then
            if curl -s http://localhost:5000 2>/dev/null | grep -q "ico-register"; then
              echo "‚úÖ Installation complete! nopCommerce is ready."
              exit 0
            fi
          fi
          
          # Status 000 means app is down (likely restarting after install)
          if [ "$STATUS" == "000" ]; then
            if [ "$RESTART_DETECTED" == "false" ]; then
              echo "üîÑ App restart detected (normal after installation)..."
              RESTART_DETECTED=true
            fi
            echo "[$i/60] Waiting for app to come back online..."
          else
            echo "[$i/60] Status: $STATUS (waiting for installation...)"
          fi
          
          sleep 10
        done
        
        echo "‚ùå Installation timeout after 10+ minutes"
        docker logs nop_app --tail 50
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:5000

    - name: Upload Allure report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-results/
        retention-days: 7