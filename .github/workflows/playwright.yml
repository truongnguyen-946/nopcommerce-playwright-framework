name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Start nopCommerce Container
      run: |
        sleep 20
        
        docker run -d \
          --name nop_app \
          --network host \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for nopCommerce to start..."
        sleep 30

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Automate Installation with Playwright
      run: |
        cat > install.mjs << 'EOF'
        import { chromium } from '@playwright/test';

        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          try {
            console.log('Opening installation page...');
            await page.goto('http://localhost:80/install', { waitUntil: 'domcontentloaded', timeout: 60000 });
            
            // Wait for form to be ready
            await page.waitForSelector('select#DataProvider', { state: 'visible', timeout: 10000 });
            
            console.log('Filling database information...');
            
            // Debug: Get all available options
            const options = await page.$$eval('select#DataProvider option', opts => 
              opts.map(opt => ({ value: opt.value, text: opt.textContent }))
            );
            console.log('Available database options:', JSON.stringify(options, null, 2));
            
            // Select SQL Server by value (try common variations)
            const sqlServerOption = options.find(opt => 
              opt.value.toLowerCase().includes('sql') || 
              opt.text.toLowerCase().includes('sql server')
            );
            
            if (sqlServerOption) {
              console.log(`Selecting option: ${sqlServerOption.value}`);
              await page.selectOption('select#DataProvider', sqlServerOption.value);
            } else {
              throw new Error('SQL Server option not found in dropdown');
            }
            
            // Wait for connection string fields to appear
            await page.waitForTimeout(2000);
            
            console.log('Filling connection details...');
            await page.fill('input#ServerName', 'localhost');
            await page.fill('input#DatabaseName', 'nopCommerce');
            
            // Uncheck Windows Authentication
            const integratedAuth = page.locator('input#IntegratedSecurity');
            if (await integratedAuth.isChecked()) {
              await integratedAuth.uncheck();
              await page.waitForTimeout(500);
            }
            
            await page.fill('input#Username', 'sa');
            await page.fill('input#Password', 'Can@922946');
            
            // Check Trust Server Certificate if it exists
            const trustCert = page.locator('input#TrustServerCertificate');
            if (await trustCert.count() > 0) {
              await trustCert.check();
            }
            
            console.log('Filling admin information...');
            await page.fill('input#AdminEmail', 'admin@yourstore.com');
            await page.fill('input#AdminPassword', 'admin123');
            await page.fill('input#ConfirmPassword', 'admin123');
            
            console.log('Enabling sample data...');
            const sampleDataCheckbox = page.locator('input#InstallSampleData');
            if (await sampleDataCheckbox.count() > 0) {
              await sampleDataCheckbox.check();
            }
            
            console.log('Submitting installation form...');
            await page.click('button[type="submit"]');
            
            console.log('Waiting for installation to complete (this may take 3-5 minutes)...');
            // Wait for redirect to home page (installation complete)
            await page.waitForURL('http://localhost:80/', { timeout: 360000 });
            
            console.log('✅ Installation completed successfully!');
            await browser.close();
            process.exit(0);
          } catch (error) {
            console.error('❌ Installation failed:', error.message);
            await page.screenshot({ path: 'installation-error.png', fullPage: true });
            console.log('Page URL:', page.url());
            await browser.close();
            process.exit(1);
          }
        })();
        EOF
        
        node install.mjs

    - name: Verify Installation Success
      run: |
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)
        if [ "$STATUS" == "200" ]; then
          echo "✅ nopCommerce is ready for testing!"
        else
          echo "❌ Unexpected status: $STATUS"
          docker logs nop_app --tail 30
          exit 1
        fi

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7