name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Pre-create Database
      run: |
        sleep 20
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Can@922946" -Q "CREATE DATABASE [nopCommerce];" -C

    - name: Run nopCommerce (Zero-Config Mode)
      run: |
        # Chạy App mà KHÔNG mount volume để tránh lỗi tranh chấp quyền (Resource busy/Permission denied)
        docker run -d \
          --name nop_app \
          --network host \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -e NOP_DB_CONNECTION_STRING="Server=localhost,1433;Database=nopCommerce;User ID=sa;Password=Can@922946;TrustServerCertificate=True;Encrypt=False" \
          -e NOP_DB_PROVIDER="sqlserver" \
          -e NOP_INSTALL_SAMPLE_DATA="True" \
          -e NOP_ADMIN_EMAIL="admin@yourstore.com" \
          -e NOP_ADMIN_PASSWORD="admin_password" \
          nopcommerceteam/nopcommerce:latest

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Wait for App ready
      run: |
        echo "Waiting for nopCommerce to initialize (First run takes ~2 mins)..."
        # Đợi tối thiểu 90s để SQL Server và App bắt đầu tạo bảng
        sleep 90
        
        for i in {1..40}; do
          # Kiểm tra status code, follow redirect (-L)
          # Nếu thấy chữ "nopCommerce" trong nội dung trả về là thành công
          RESPONSE=$(curl -sL http://localhost:80)
          
          if echo "$RESPONSE" | grep -q "nopCommerce"; then
            echo "SUCCESS: App is rendered and ready for testing!"
            exit 0
          fi

          # Kiểm tra xem có class ico-register (nút đăng ký) trong HTML không
          if echo "$RESPONSE" | grep -q "ico-register"; then
            echo "SUCCESS: Register button found! App is fully ready."
            exit 0
          fi
          
          echo "Attempt $i: App is up but UI components (ico-register) are not rendered yet. Waiting 15s..."
          sleep 15

          
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)
          echo "Attempt $i: Status $STATUS. App is still building database..."
          
          # Nếu gặp lỗi 500 hoặc 404, in log để debug ngay
          if [ "$STATUS" == "500" ]; then
            docker logs nop_app --tail 20
          fi
          
          sleep 15
        done
        echo "FAILED: Final Container Logs:"
        docker logs nop_app --tail 100
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80