name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    # BƯỚC 1: Tạo file cấu hình để Skip Install
    - name: Create nopCommerce Configuration
      run: |
        mkdir -p App_Data
        echo '{
          "DataConfig": {
            "DataProvider": "sqlserver",
            "ConnectionString": "Server=localhost,1433;Database=nopCommerce;User ID=sa;Password=Can@922946;TrustServerCertificate=True;Encrypt=False",
            "Dbms": "sqlserver"
          }
        }' > App_Data/dataSettings.json

    # BƯỚC 2: Tạo Database và ép App không phải chạy Migration nặng
    - name: Prepare Database
      run: |
        # Chờ SQL Server thực sự sống
        sleep 20
        # Tạo DB rỗng
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Can@922946" -Q "CREATE DATABASE [nopCommerce];" -C

    # BƯỚC 3: Chạy App với RAM tối ưu
    - name: Run nopCommerce
      run: |
        docker run -d \
          --name nop_app \
          --network host \
          -v $(pwd)/App_Data/dataSettings.json:/app/App_Data/dataSettings.json \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -e DOTNET_PRINT_TELEMETRY_MESSAGE=false \
          nopcommerceteam/nopcommerce:latest
        
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install pnpm & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    # BƯỚC 4: Kiểm tra thông minh hơn
    - name: Wait for App (Max 5 mins)
      run: |
        echo "Check log initial..."
        sleep 30
        docker logs nop_app --tail 50
        
        # Thử kết nối, nếu lỗi thì in log ra ngay để biết tại sao
        for i in {1..30}; do
          if curl -s http://localhost:80 | grep -q "nopCommerce"; then
            echo "Success: nopCommerce is UP!"
            exit 0
          fi
          echo "Attempt $i: App is still loading tables... (Wait 10s)"
          docker logs nop_app --tail 3
          sleep 10
        done
        echo "Timeout! Showing logs for debugging:"
        docker logs nop_app
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80