name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Start nopCommerce Container
      run: |
        sleep 20
        
        docker run -d \
          --name nop_app \
          --network host \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for nopCommerce to start..."
        sleep 30

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Automate Installation with Playwright
      run: |
        cat > install.mjs << 'EOF'
        import { chromium } from '@playwright/test';

        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          console.log('Opening installation page...');
          await page.goto('http://localhost:80/install', { waitUntil: 'networkidle' });
          
          console.log('Filling database information...');
          await page.selectOption('select#DataProvider', 'sqlserver');
          await page.fill('input#ServerName', 'localhost');
          await page.fill('input#DatabaseName', 'nopCommerce');
          await page.fill('input#Username', 'sa');
          await page.fill('input#Password', 'Can@922946');
          await page.check('input#TrustServerCertificate');
          
          console.log('Filling admin information...');
          await page.fill('input#AdminEmail', 'admin@yourstore.com');
          await page.fill('input#AdminPassword', 'admin123');
          await page.fill('input#ConfirmPassword', 'admin123');
          
          console.log('Enabling sample data...');
          await page.check('input#InstallSampleData');
          
          console.log('Submitting installation form...');
          await page.click('button[type="submit"]');
          
          console.log('Waiting for installation to complete (this may take 3-5 minutes)...');
          await page.waitForURL('http://localhost:80/', { timeout: 360000 });
          
          console.log('✅ Installation completed successfully!');
          await browser.close();
        })();
        EOF
        
        node install.mjs

    - name: Verify Installation Success
      run: |
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)
        if [ "$STATUS" == "200" ]; then
          echo "✅ nopCommerce is ready for testing!"
        else
          echo "❌ Unexpected status: $STATUS"
          docker logs nop_app --tail 30
          exit 1
        fi

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7