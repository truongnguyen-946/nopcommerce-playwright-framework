name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    # BƯỚC QUAN TRỌNG: Tạo file cấu hình để Skip bước Install
    - name: Create nopCommerce Configuration
      run: |
        mkdir -p App_Data
        echo '{
          "DataConfig": {
            "DataProvider": "sqlserver",
            "ConnectionString": "Server=localhost,1433;Database=nopCommerce;User ID=sa;Password=Can@922946;TrustServerCertificate=True;Encrypt=False",
            "Dbms": "sqlserver"
          }
        }' > App_Data/dataSettings.json

    # BƯỚC QUAN TRỌNG: Tạo Database trống trước (Vì chúng ta đã skip install)
    - name: Pre-create Database
      run: |
        sudo apt-get update && sudo apt-get install -y mssql-tools18 unixodbc-dev
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Can@922946" -Q "CREATE DATABASE [nopCommerce];" -C

    # BƯỚC MỚI: Chạy nopCommerce bằng Docker Run thay vì Service để Mount được file cấu hình
    - name: Run nopCommerce Container
      run: |
        docker run -d \
          --name nopcommerce_app \
          --network host \
          -v $(pwd)/App_Data/dataSettings.json:/app/App_Data/dataSettings.json \
          -e ASPNETCORE_ENVIRONMENT=Development \
          nopcommerceteam/nopcommerce:latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      run: pnpm install

    - name: Install Playwright Browsers
      run: pnpm exec playwright install --with-deps chromium

    - name: Wait for nopCommerce to be ready
      run: |
        echo "Waiting for nopCommerce to start..."
        # Đợi App phản hồi (nopCommerce khởi động lần đầu vẫn mất khoảng 30-60s)
        timeout 300 bash -c 'until curl -s http://localhost:80 | grep -q "nopCommerce"; do echo "App is starting up..."; sleep 10; done'
        echo "nopCommerce is ready!"

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30